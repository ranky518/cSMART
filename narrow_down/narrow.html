<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=NhtP5OLdtjUsS3w4ImMW2TO8ocoJ3S5Q"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/library/Heatmap/2.0/src/Heatmap_min.js"></script>
    <script type="text/javascript" src="narrow.js"></script>
    <title>GPS轨迹热力图</title>
    <style type="text/css">
        ul,li{list-style: none;margin:0;padding:0;float:left;}
        html{height:100%}
        body{height:100%;margin:0px;padding:0px;font-family:"微软雅黑";}
        #container{height:100%;width:100%;}
        #r-result{
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 999;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        #r-result input[type="button"] {
            margin: 5px;
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: #fff;
        }
        #r-result input[type="button"]:hover {
            background: #f0f0f0;
        }
    </style>    
</head>
<body>
    <div id="container"></div>
    <div id="r-result">
        <strong>热力图控制</strong><br>
        <input type="button"  onclick="openHeatmap();" value="显示热力图"/>
        <input type="button"  onclick="closeHeatmap();" value="关闭热力图"/>
    </div>
</body>
</html>
<script type="text/javascript">
    var map = new BMap.Map("container");          // 创建地图实例
    var point = new BMap.Point(116.34203268545464, 39.95157905557601);
    map.centerAndZoom(new BMap.Point(116.34203268545464, 39.95157905557601), 12);             // 初始化地图，设置中心点坐标和地图级别
    map.enableScrollWheelZoom(); // 允许滚轮缩放
   
    if(!isSupportCanvas()){
        alert('热力图目前只支持有canvas支持的浏览器,您所使用的浏览器不能使用热力图功能~')
    }
    
    // 检查数据是否加载
    var heatmapOverlay = null;
    if (typeof points !== 'undefined' && points.length > 0) {
        // 转换数据格式为百度地图热力图所需格式
        var heatmapData = [];
        var maxCount = 0;
        
        for (var i = 0; i < points.length; i++) {
            var point = points[i];
            if (point.lat && point.lng && !isNaN(point.lat) && !isNaN(point.lng)) {
                var count = point.count || 1;
                heatmapData.push({
                    lng: point.lng,
                    lat: point.lat,
                    count: count
                });
                if (count > maxCount) {
                    maxCount = count;
                }
            }
        }
        
        if (heatmapData.length > 0) {
            //详细的参数,可以查看heatmap.js的文档 https://github.com/pa7/heatmap.js/blob/master/README.md
            //参数说明如下:
            /* visible 热力图是否显示,默认为true
             * opacity 热力的透明度,1-100
             * radius 势力图的每个点的半径大小   
             * gradient  {JSON} 热力图的渐变区间 . gradient如下所示
             *    {
                    .2:'rgb(0, 255, 255)',
                    .5:'rgb(0, 110, 255)',
                    .8:'rgb(100, 0, 255)'
                }
                其中 key 表示插值的位置, 0~1. 
                    value 为颜色值. 
             */
            heatmapOverlay = new BMapLib.HeatmapOverlay({"radius":20});
            map.addOverlay(heatmapOverlay);
            heatmapOverlay.setDataSet({data: heatmapData, max: maxCount});
        } else {
            alert('没有有效的热力图数据');
        }
    } else {
        alert('无法加载热力图数据，请确保 new_heatmap_points.js 文件存在且格式正确');
    }
    
    //是否显示热力图
    function openHeatmap(){
        if (heatmapOverlay) {
            heatmapOverlay.show();
        }
    }
    function closeHeatmap(){
        if (heatmapOverlay) {
            heatmapOverlay.hide();
        }
    }
    // 初始状态：显示热力图
    if (heatmapOverlay) {
        heatmapOverlay.show();
    }
    
    //判断浏览区是否支持canvas
    function isSupportCanvas(){
        var elem = document.createElement('canvas');
        return !!(elem.getContext && elem.getContext('2d'));
    }
</script>